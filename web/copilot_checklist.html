<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1.0" />
 <title>Co‑Pilot Checklist</title>
 <style>
   :root {
     --ok: #00d26a;
     --warn: #ffaa00;
     --bad: #ff3b3b;
     --bg: #0e1420;
     --fg: #e6f0ff;
     --muted: #7f8da3;
     --card: #152038;
   }
   body { margin: 0; padding: 20px; font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif; color: var(--fg); background: radial-gradient(1200px 800px at 70% -10%, #1b2a4a, var(--bg)); }
   .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
   .card { background: var(--card); border-radius: 12px; padding: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.25); }
   h1 { font-size: 20px; margin: 0 0 12px 0; letter-spacing: .5px; }
   .status { font-size: 12px; color: var(--muted); margin-bottom: 8px; }
   .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; }
   .pill.ok { background: rgba(0,210,106,0.15); color: var(--ok); border: 1px solid rgba(0,210,106,0.35); }
   .pill.warn { background: rgba(255,170,0,0.15); color: var(--warn); border: 1px solid rgba(255,170,0,0.35); }
   .pill.bad { background: rgba(255,59,59,0.15); color: var(--bad); border: 1px solid rgba(255,59,59,0.35); }
   .flight-data { font-family: Consolas, Menlo, monospace; font-size: 13px; }
   .data-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed rgba(255,255,255,0.08); }
   .data-row:last-child { border-bottom: none; }
   .light { display: flex; align-items: center; gap: 10px; padding: 6px 0; }
   .dot { width: 12px; height: 12px; border-radius: 50%; background: #777; box-shadow: 0 0 0 2px rgba(255,255,255,0.06) inset; }
   .dot.ok { background: var(--ok); box-shadow: 0 0 16px rgba(0,210,106,0.7); }
   .dot.warn { background: var(--warn); box-shadow: 0 0 16px rgba(255,170,0,0.7); }
   .dot.bad { background: var(--bad); box-shadow: 0 0 16px rgba(255,59,59,0.7); }
   .section-title { margin: 12px 0 6px; font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: .12em; }
   .checklist-info { margin-top: 16px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; border-left: 3px solid var(--muted); }
   .checklist-info h3 { margin: 0 0 8px 0; font-size: 13px; color: var(--fg); }
   .checklist-info ul { margin: 6px 0; padding-left: 16px; }
   .checklist-info li { margin: 3px 0; font-size: 12px; color: var(--muted); line-height: 1.4; }
   footer { margin-top: 16px; font-size: 12px; color: var(--muted); }
   code { background: #0b1322; padding: 2px 6px; border-radius: 6px; color: #b7cffb; }
 </style>
</head>
<body>
 <h1>Co‑Pilot Checklist</h1>
 <div class="status">WebSocket: <span id="wsStatus" class="pill">connecting…</span></div>

 <div class="grid">
   <div class="card">
     <div class="section-title">Flight Data</div>
     <div class="flight-data" id="flightData"></div>
   </div>
   <div class="card">
     <div class="section-title">Takeoff Checklist</div>
     <div id="takeoffList"></div>
     <div class="section-title">Landing Checklist</div>
     <div id="landingList"></div>
   </div>
 </div>

 <div class="checklist-info">
   <h3>Takeoff Checklist Criteria:</h3>
   <ul>
     <li><strong>Flaps configured:</strong> Any flap extension (> 0%) for takeoff lift</li>
     <li><strong>Throttle > 60%:</strong> Adequate power for acceleration and rotation</li>
     <li><strong>IAS alive > 30 kt:</strong> Airspeed indicator functioning, sufficient speed for controls</li>
     <li><strong>Positive pitch (+5° to +15°):</strong> Nose up attitude for climb after rotation</li>
     <li><strong>Low altitude (< 1000 ft):</strong> Still in takeoff phase, not yet in cruise</li>
   </ul>
   
   <h3>Landing Checklist Criteria:</h3>
   <ul>
     <li><strong>Stable descent (< 2000 fpm):</strong> Controlled descent rate, not too steep</li>
     <li><strong>Flaps set for landing (≥ 15%):</strong> Increased lift and drag for approach</li>
     <li><strong>IAS below 120 kt:</strong> Appropriate approach speed for most aircraft</li>
     <li><strong>Landing pitch (+2° to +8°):</strong> Slight nose-up attitude for proper flare</li>
     <li><strong>Power reduced (< 50%):</strong> Reduced thrust for controlled descent</li>
     <li><strong>Descent rate ≤ 1000 fpm:</strong> Safe vertical speed for landing approach</li>
   </ul>
 </div>

 <footer>
   Uses canonical variables: <code>Aircraft.Flaps</code>, <code>Aircraft.Throttle</code>, 
   <code>Aircraft.IndicatedAirspeed</code>, <code>Aircraft.Altitude</code>, 
   <code>Aircraft.VerticalSpeed</code>, <code>Aircraft.Pitch</code>, 
   <code>Aircraft.MagneticHeading</code> / <code>Aircraft.TrueHeading</code>.
 </footer>

 <script>
   const wsUrl = 'ws://localhost:8765';
   let ws = null;
   let reconnectTimer = null;

   const el = (id) => document.getElementById(id);
   const wsStatus = el('wsStatus');
   const flightData = el('flightData');
   const takeoffList = el('takeoffList');
   const landingList = el('landingList');

   const M_TO_FT = 3.280839895;
   const MPS_TO_KT = 1.943844492;
   const RAD_TO_DEG = 180 / Math.PI;

   function setWsState(state) {
     wsStatus.textContent = state;
     wsStatus.className = 'pill ' + (state === 'connected' ? 'ok' : (state === 'connecting…' ? '' : 'bad'));
   }

   function compassHeadingFromCanonical(src) {
     const hdgMathDeg = (Math.abs(src) <= 6.5) ? (src * RAD_TO_DEG) % 360 : (src % 360);
     let heading = (90 - hdgMathDeg) % 360; if (heading < 0) heading += 360;
     return heading;
   }

   function light(label, state) {
     const row = document.createElement('div'); row.className = 'light';
     const d = document.createElement('span'); d.className = 'dot ' + state;
     const t = document.createElement('span'); t.textContent = label;
     row.appendChild(d); row.appendChild(t);
     return row;
   }

   function render(data) {
     const v = (data && data.variables) || {};

     const flaps = Number(v['Aircraft.Flaps'] || 0);
     const throttle = Number(v['Aircraft.Throttle'] || 0);
     const ias = Number(v['Aircraft.IndicatedAirspeed'] || 0) * MPS_TO_KT; // m/s → kt
     const alt = Number(v['Aircraft.Altitude'] || 0) * M_TO_FT; // m → ft
     const vs = Number(v['Aircraft.VerticalSpeed'] || 0) * 196.850394; // m/s → fpm
     const pitch = Number(v['Aircraft.Pitch'] || 0) * RAD_TO_DEG; // rad → deg
     const hdgSrc = (v['Aircraft.MagneticHeading'] ?? v['Aircraft.TrueHeading'] ?? 0);
     const heading = compassHeadingFromCanonical(hdgSrc);

     // Flight data - cada variable en su propia fila
     flightData.innerHTML = `
       <div class="data-row">
         <span>Heading</span><span>${heading.toFixed(0)}°</span>
       </div>
       <div class="data-row">
         <span>IAS</span><span>${ias.toFixed(0)} kt</span>
       </div>
       <div class="data-row">
         <span>Altitude</span><span>${alt.toFixed(0)} ft</span>
       </div>
       <div class="data-row">
         <span>Vertical Speed</span><span>${(vs>=0?'+':'') + vs.toFixed(0)} fpm</span>
       </div>
       <div class="data-row">
         <span>Pitch</span><span>${(pitch>=0?'+':'') + pitch.toFixed(1)}°</span>
       </div>
       <div class="data-row">
         <span>Flaps</span><span>${(flaps*100).toFixed(0)} %</span>
       </div>
       <div class="data-row">
         <span>Throttle</span><span>${(throttle*100).toFixed(0)} %</span>
       </div>
     `;

     // Takeoff checklist
     takeoffList.innerHTML = '';
     takeoffList.appendChild(light('Flaps configured', (flaps > 0) ? 'ok' : 'warn'));
     takeoffList.appendChild(light('Throttle > 60%', (throttle > 0.60) ? 'ok' : 'warn'));
     takeoffList.appendChild(light('IAS alive > 30 kt', (ias > 30) ? 'ok' : 'warn'));
     takeoffList.appendChild(light('Positive pitch (+5° to +15°)', (pitch > 5 && pitch < 15) ? 'ok' : 'warn'));
     takeoffList.appendChild(light('Low altitude (< 1000 ft)', (alt < 1000) ? 'ok' : 'warn'));

     // Landing checklist
     landingList.innerHTML = '';
     const stableDescent = (vs < 0 && Math.abs(vs) < 2000); // Descendiendo y < 2000 fpm
     const flapsLanding = flaps >= 0.15;
     const landingPitch = (pitch > 2 && pitch < 8);
     const powerReduced = (throttle < 0.5);
     const vsOk = Math.abs(vs) <= 1000;
     
     landingList.appendChild(light('Stable descent (< 2000 fpm)', stableDescent ? 'ok' : 'warn'));
     landingList.appendChild(light('Flaps set for landing (≥ 15%)', flapsLanding ? 'ok' : 'warn'));
     landingList.appendChild(light('IAS below 120 kt', (ias < 120) ? 'ok' : 'warn'));
     landingList.appendChild(light('Landing pitch (+2° to +8°)', landingPitch ? 'ok' : 'warn'));
     landingList.appendChild(light('Power reduced (< 50%)', powerReduced ? 'ok' : 'warn'));
     landingList.appendChild(light('Descent rate ≤ 1000 fpm', vsOk ? 'ok' : 'bad'));
   }

   function connect() {
     try {
       setWsState('connecting…');
       ws = new WebSocket(wsUrl);
       ws.onopen = () => { setWsState('connected'); if (reconnectTimer) { clearInterval(reconnectTimer); reconnectTimer = null; } };
       ws.onmessage = (ev) => { try { const data = JSON.parse(ev.data); render(data); } catch (e) {} };
       ws.onclose = () => { setWsState('disconnected'); if (!reconnectTimer) reconnectTimer = setInterval(connect, 3000); };
       ws.onerror = () => { setWsState('error'); };
     } catch (_) {
       setWsState('error');
       if (!reconnectTimer) reconnectTimer = setInterval(connect, 3000);
     }
   }

   connect();
 </script>
</body>
</html>